{"version":3,"file":"mistx-connect.esm.js","sources":["../src/socket.ts"],"sourcesContent":["import { io, Socket } from 'socket.io-client'\nimport { BigNumberish, BigNumber } from '@ethersproject/bignumber'\n\nexport enum Event {\n  FEES_CHANGE = 'FEES_CHANGE',\n  SOCKET_SESSION = 'SOCKET_SESSION',\n  SOCKET_ERR = 'SOCKET_ERR',\n  BUNDLE_REQUEST = 'BUNDLE_REQUEST',\n  MISTX_BUNDLE_REQUEST = 'MISTX_BUNDLE_REQUEST',\n  BUNDLE_STATUS_REQUEST = 'BUNDLE_STATUS_REQUEST',\n  BUNDLE_STATUS_RESPONSE = 'BUNDLE_STATUS_RESPONSE',\n  BUNDLE_RESPONSE = 'BUNDLE_RESPONSE',\n  BUNDLE_CANCEL_REQUEST = 'BUNDLE_CANCEL_REQUEST'\n}\n\nexport interface Fee {\n  maxFeePerGas: BigNumber\n  maxPriorityFeePerGas: BigNumber\n}\nexport interface Fees {\n  block: number\n  baseFeePerGas: BigNumber\n  default: Fee\n  low: Fee\n  med: Fee\n  high: Fee\n}\n\nexport enum Status {\n  PENDING_BUNDLE = 'PENDING_BUNDLE',\n  FAILED_BUNDLE = 'FAILED_BUNDLE',\n  SUCCESSFUL_BUNDLE = 'SUCCESSFUL_BUNDLE',\n  CANCEL_BUNDLE_SUCCESSFUL = 'CANCEL_BUNDLE_SUCCESSFUL',\n  BUNDLE_NOT_FOUND = 'BUNDLE_NOT_FOUND'\n}\n\nexport const STATUS_LOCALES: Record<string, string> = {\n  PENDING_BUNDLE: 'Flashbots working on including your swap',\n  FAILED_BUNDLE: 'Failed',\n  SUCCESSFUL_BUNDLE: 'Success',\n  CANCEL_BUNDLE_SUCCESSFUL: 'Cancelled',\n  BUNDLE_NOT_FOUND: 'Failed'\n}\n\nexport enum Diagnosis {\n  LOWER_THAN_TAIL = 'LOWER_THAN_TAIL',\n  NOT_A_FLASHBLOCK = 'NOT_A_FLASHBLOCK',\n  BUNDLE_OUTBID = 'BUNDLE_OUTBID',\n  ERROR_API_BEHIND = 'ERROR_API_BEHIND',\n  MISSING_BLOCK_DATA = 'MISSING_BLOCK_DATA',\n  ERROR_UNKNOWN = 'ERROR_UNKNOWN'\n}\n\nexport interface MistXVersion {\n  api: string\n  client: string\n}\n\nexport interface SocketSession {\n  token: string\n  version: MistXVersion | undefined\n}\n\nexport interface TransactionReq {\n  serialized: string // serialized transaction\n  raw: SwapReq | undefined // raw def. of each type of trade\n  estimatedGas?: number\n  estimatedEffectiveGasPrice?: number\n}\n\nexport interface TransactionProcessed {\n  serialized: string // serialized transaction\n  bundle: string // bundle.serialized\n  raw: SwapReq | undefined // raw def. of each type of trade\n  estimatedGas: number\n  estimatedEffectiveGasPrice: number\n}\n\nexport interface BundleReq {\n  transactions: TransactionReq[] | string[]\n  chainId?: number\n  bribe?: string // BigNumber\n  from?: string\n  deadline?: BigNumberish\n  simulateOnly?: boolean\n}\n\nexport interface SwapReq {\n  amount0: BigNumberish\n  amount1: BigNumberish\n  path: Array<string>\n  to: string\n}\n\nexport interface BundleProcessed {\n  serialized: string\n  transactions: TransactionProcessed[]\n  bribe: BigNumberish\n  sessionToken: string\n  chainId: number\n  timestamp: number // EPOCH,\n  totalEstimatedGas: number\n  totalEstimatedEffectiveGasPrice: number\n  from: string\n  deadline: BigNumberish\n  simulateOnly: boolean\n}\n\nexport interface BundleRes {\n  bundle: BundleProcessed\n  status: string\n  message: string\n  error: string\n}\n\nexport interface BundleStatusRes {\n  bundle: string | BundleProcessed // BundleProcessed.serialized\n  status: string\n  message: string\n  error: string\n}\n\ninterface QuoteEventsMap {\n  [Event.SOCKET_SESSION]: (response: SocketSession) => void\n  [Event.SOCKET_ERR]: (err: any) => void\n  [Event.FEES_CHANGE]: (response: Fees) => void\n  [Event.BUNDLE_REQUEST]: (response: any) => void\n  [Event.MISTX_BUNDLE_REQUEST]: (response: any) => void\n  [Event.BUNDLE_RESPONSE]: (response: BundleRes) => void\n  [Event.BUNDLE_CANCEL_REQUEST]: (serialized: any) => void // TO DO - any\n  [Event.BUNDLE_STATUS_REQUEST]: (serialized: any) => void // TO DO - any\n  [Event.BUNDLE_STATUS_RESPONSE]: (serialized: BundleStatusRes) => void // TO DO - any\n}\n\ninterface SocketOptions {\n  onConnect?: () => void\n  onConnectError?: (err: any) => void\n  onDisconnect?: (err: any) => void\n  onError?: (err: any) => void\n  onFeesChange?: (fees: Fees) => void\n  onSocketSession: (session: any) => void\n  onTransactionResponse?: (response: BundleRes) => void\n  onTransactionUpdate?: (response: BundleStatusRes) => void\n}\n\nconst defaultServerUrl = 'https://mistx-app-goerli.herokuapp.com'\nconst tokenKey = `SESSION_TOKEN`\n\nexport class MistxSocket {\n  private socket: Socket<QuoteEventsMap, QuoteEventsMap>\n\n  constructor(serverUrl: string = defaultServerUrl) {\n    const token = localStorage.getItem(tokenKey)\n    const socket: Socket<QuoteEventsMap, QuoteEventsMap> = io(serverUrl, {\n      transports: ['websocket'],\n      auth: { token },\n      reconnection: true,\n      reconnectionDelay: 5000,\n      autoConnect: true\n    })\n    this.socket = socket\n  }\n\n  private disconnect() {\n    this.socket.off('connect')\n    this.socket.off('connect_error')\n    this.socket.off(Event.SOCKET_ERR)\n    this.socket.off(Event.SOCKET_SESSION)\n    this.socket.off(Event.FEES_CHANGE)\n    this.socket.off(Event.BUNDLE_RESPONSE)\n    this.socket.off(Event.BUNDLE_STATUS_RESPONSE)\n  }\n\n  public closeConnection() {\n    this.socket.disconnect()\n  }\n\n  public init({\n    onConnect,\n    onConnectError,\n    onDisconnect,\n    onError,\n    onFeesChange,\n    onSocketSession,\n    onTransactionResponse,\n    onTransactionUpdate,\n  }: SocketOptions): () => void {\n    this.socket.on('connect', () => {\n      // console.log('websocket connected')\n      if (onConnect) onConnect()\n    })\n  \n    this.socket.on('connect_error', (err: any) => {\n      // console.log('websocket connect error', err)\n      if (onConnectError) onConnectError(err)\n    })\n  \n    this.socket.on('disconnect', (err: any) => {\n      // console.log('websocket disconnect', err)\n      if (onDisconnect) onDisconnect(err)\n    })\n  \n    this.socket.on(Event.SOCKET_ERR, (err: any) => {\n      // console.log('websocket err', err)\n      if (onError) onError(err)\n    })\n  \n    this.socket.on(Event.SOCKET_SESSION, (session: any) => {\n      localStorage.setItem(tokenKey, session.token)\n      if (onSocketSession) onSocketSession(session)\n    })\n  \n    this.socket.on(Event.FEES_CHANGE, (response: Fees) => {\n      if (onFeesChange) {\n        const fees: Fees = {\n          block: response.block,\n          baseFeePerGas: BigNumber.from(response.baseFeePerGas),\n          default: {\n            maxFeePerGas: BigNumber.from(response.default.maxFeePerGas),\n            maxPriorityFeePerGas: BigNumber.from(response.default.maxPriorityFeePerGas)\n          },\n          low: {\n            maxFeePerGas: BigNumber.from(response.low.maxFeePerGas),\n            maxPriorityFeePerGas: BigNumber.from(response.low.maxPriorityFeePerGas)\n          },\n          med: {\n            maxFeePerGas: BigNumber.from(response.med.maxFeePerGas),\n            maxPriorityFeePerGas: BigNumber.from(response.med.maxPriorityFeePerGas)\n          },\n          high: {\n            maxFeePerGas: BigNumber.from(response.high.maxFeePerGas),\n            maxPriorityFeePerGas: BigNumber.from(response.high.maxPriorityFeePerGas)\n          },\n        }\n        onFeesChange(fees)\n      }\n    })\n  \n    this.socket.on(Event.BUNDLE_RESPONSE, (response: BundleRes) => {\n      if (onTransactionResponse) onTransactionResponse(response)\n    })\n  \n    this.socket.on(Event.BUNDLE_STATUS_RESPONSE, (response: BundleStatusRes) => {\n      if (onTransactionUpdate) onTransactionUpdate(response)\n    })\n  \n    return () => {\n      this.disconnect()\n    }\n  }\n\n  public emitBundleRequest(bundle: BundleReq) {\n    this.socket.emit(Event.BUNDLE_REQUEST, bundle)\n  }\n\n  public emitTransactionRequest(bundle: BundleReq) {\n    this.socket.emit(Event.MISTX_BUNDLE_REQUEST, bundle)\n  }\n\n  public emitStatusRequest(id: string) {\n    this.socket.emit(Event.BUNDLE_STATUS_REQUEST, {\n      serialized: id\n    })\n  }\n  \n  public emitTransactionCancellation(id: string) {\n    this.socket.emit(Event.BUNDLE_CANCEL_REQUEST, {\n      serialized: id\n    })\n  }\n}\n"],"names":["Event","Status","STATUS_LOCALES","PENDING_BUNDLE","FAILED_BUNDLE","SUCCESSFUL_BUNDLE","CANCEL_BUNDLE_SUCCESSFUL","BUNDLE_NOT_FOUND","Diagnosis","defaultServerUrl","tokenKey","MistxSocket","serverUrl","token","localStorage","getItem","socket","io","transports","auth","reconnection","reconnectionDelay","autoConnect","disconnect","off","SOCKET_ERR","SOCKET_SESSION","FEES_CHANGE","BUNDLE_RESPONSE","BUNDLE_STATUS_RESPONSE","closeConnection","init","onConnect","onConnectError","onDisconnect","onError","onFeesChange","onSocketSession","onTransactionResponse","onTransactionUpdate","on","err","session","setItem","response","fees","block","baseFeePerGas","BigNumber","from","maxFeePerGas","maxPriorityFeePerGas","low","med","high","emitBundleRequest","bundle","emit","BUNDLE_REQUEST","emitTransactionRequest","MISTX_BUNDLE_REQUEST","emitStatusRequest","id","BUNDLE_STATUS_REQUEST","serialized","emitTransactionCancellation","BUNDLE_CANCEL_REQUEST"],"mappings":"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"}